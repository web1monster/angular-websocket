!function(){function e(e,t,n,c){function l(t){t&&!e.$$phase&&e.$apply()}function u(e){this.url=e,this._reconnectAttempts=0,this.initialTimeout=500,this.maxTimeout=3e5,this.sendQueue=[],this.onOpenCallbacks=[],this.onMessageCallbacks=[],this.onErrorCallbacks=[],this.onCloseCallbacks=[],o(this._readyStateConstants),this._connect()}return u.prototype._readyStateConstants={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,RECONNECT_ABORTED:4},u.prototype._reconnectableStatusCodes=[4e3],u.prototype.close=function(e){(e||!this.socket.bufferedAmount)&&this.socket.close()},u.prototype._connect=function(e){(e||!this.socket||1!==this.socket.readyState)&&(this.socket=c.createWebSocketBackend(this.url),this.socket.onopen=this._onOpenHandler.bind(this),this.socket.onmessage=this._onMessageHandler.bind(this),this.socket.onerror=this._onErrorHandler.bind(this),this.socket.onclose=this._onCloseHandler.bind(this))},u.prototype.fireQueue=function(){for(;this.sendQueue.length&&1===this.socket.readyState;){var e=this.sendQueue.shift();this.socket.send(r(e.message)?e.message:JSON.stringify(e.message)),e.deferred.resolve()}},u.prototype.notifyOpenCallbacks=function(){for(var e=0;e<this.onOpenCallbacks.length;e++)this.onOpenCallbacks[e].call(this)},u.prototype.notifyCloseCallbacks=function(){for(var e=0;e<this.onCloseCallbacks.length;e++)this.onCloseCallbacks[e].call(this)},u.prototype.notifyErrorCallbacks=function(e){for(var t=0;t<this.onErrorCallbacks.length;t++)this.onErrorCallbacks[t].call(this,e)},u.prototype.onMessage=function(e,t){if(!a(e))throw new Error("Callback must be a function");if(t&&i(t.filter)&&!r(t.filter)&&!(t.filter instanceof RegExp))throw new Error("Pattern must be a string or regular expression");this.onMessageCallbacks.push({fn:e,pattern:t?t.filter:void 0,autoApply:t?t.autoApply:!0})},u.prototype._onMessageHandler=function(e){for(var t,n,o=this,s=0;s<o.onMessageCallbacks.length;s++)n=o.onMessageCallbacks[s],t=n.pattern,t?r(t)&&e.data===t?(n.fn.call(this,e),l(n.autoApply)):t instanceof RegExp&&t.exec(e.data)&&(n.fn.call(this,e),l(n.autoApply)):(n.fn.call(this,e),l(n.autoApply))},u.prototype.onClose=function(e){this.onCloseCallbacks.push(e)},u.prototype.onOpen=function(e){this.onOpenCallbacks.push(e)},u.prototype._onOpenHandler=function(){this._reconnectAttempts=0,this.notifyOpenCallbacks(),this.fireQueue()},u.prototype.onError=function(e){this.onErrorCallbacks.push(e)},u.prototype._onErrorHandler=function(e){this.notifyErrorCallbacks(e)},u.prototype._onCloseHandler=function(e){this.notifyCloseCallbacks(),this._reconnectableStatusCodes.indexOf(e.code)>-1&&this.reconnect()},u.prototype.send=function(e){function n(e){e.cancel=o;var t=e.then;return e.then=function(){var e=t.apply(this,arguments);return n(e)},e}function o(t){return r.sendQueue.splice(r.sendQueue.indexOf(e),1),s.reject(t),this}var s=t.defer(),r=this,a=n(s.promise);return r.readyState===r._readyStateConstants.RECONNECT_ABORTED?s.reject("Socket connection has been closed"):(this.sendQueue.push({message:e,deferred:s}),this.fireQueue()),a},u.prototype.reconnect=function(){this.close(),n(angular.bind(this,function(){this._connect()}),this._getBackoffDelay(++this._reconnectAttempts),!0)},u.prototype._getBackoffDelay=function(e){var t=Math.random()+1,n=this.initialTimeout,o=2,s=e,r=this.maxTimeout;return Math.floor(Math.min(t*n*Math.pow(o,s),r))},u.prototype._setInternalState=function(e){if(Math.floor(e)!==e||0>e||e>4)throw new Error("state must be an integer between 0 and 4, got: "+e);this._internalConnectionState=e,angular.forEach(this.sendQueue,function(e){e.deferred.reject("Message cancelled due to closed socket connection")})},s&&s(u.prototype,"readyState",{get:function(){return this._internalConnectionState||this.socket.readyState},set:function(){throw new Error("The readyState property is read-only")}}),function(e){return new u(e)}}function t(e){this.createWebSocketBackend=function(t){var n=/wss?:\/\//.exec(t);if(!n)throw new Error("Invalid url provided");return new e.WebSocket(t)}}var n=function(){},o=Object.freeze?Object.freeze:n,s=Object.defineProperty,r=angular.isString,a=angular.isFunction,i=angular.isDefined;e.$inject=["$rootScope","$q","$timeout","$webSocketBackend"],t.$inject=["$window"],angular.module("ngWebSocket",[]).factory("$webSocket",e).factory("WebSocket",e).service("$webSocketBackend",t).service("WebSocketBackend",t),angular.module("angular-websocket",["ngWebSocket"])}();
//# sourceMappingURL=angular-websocket.min.js.map